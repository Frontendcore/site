!function(a,b,c,d){"use strict";c.plugins.history=c.Plugin.extend({undoTransformations:[],initialize:function(){this._initButtons(),this.darkroom.addEventListener("core:transformation",this._onTranformationApplied.bind(this))},undo:function(){if(0!==this.darkroom.transformations.length){var a=this.darkroom.transformations.pop();this.undoTransformations.unshift(a),this.darkroom.reinitializeImage(),this._updateButtons()}},redo:function(){if(0!==this.undoTransformations.length){var a=this.undoTransformations.shift();this.darkroom.transformations.push(a),this.darkroom.reinitializeImage(),this._updateButtons()}},_initButtons:function(){var a=this.darkroom.toolbar.createButtonGroup();return this.backButton=a.createButton({image:"undo",disabled:!0}),this.forwardButton=a.createButton({image:"redo",disabled:!0}),this.backButton.addEventListener("click",this.undo.bind(this)),this.forwardButton.addEventListener("click",this.redo.bind(this)),this},_updateButtons:function(){this.backButton.disable(0===this.darkroom.transformations.length),this.forwardButton.disable(0===this.undoTransformations.length)},_onTranformationApplied:function(){this.undoTransformations=[],this._updateButtons()}})}(window,document,Darkroom,fabric),function(){"use strict";var a=Darkroom.Transformation.extend({applyTransformation:function(a,b,c){var d=(b.getAngle()+this.options.angle)%360;b.rotate(d);var e,f;f=Math.abs(b.getWidth()*Math.sin(d*Math.PI/180))+Math.abs(b.getHeight()*Math.cos(d*Math.PI/180)),e=Math.abs(b.getHeight()*Math.sin(d*Math.PI/180))+Math.abs(b.getWidth()*Math.cos(d*Math.PI/180)),a.setWidth(e),a.setHeight(f),a.centerObject(b),b.setCoords(),a.renderAll(),c()}});Darkroom.plugins.rotate=Darkroom.Plugin.extend({initialize:function(){var a=this.darkroom.toolbar.createButtonGroup(),b=a.createButton({image:"rotate-left"}),c=a.createButton({image:"rotate-right"});b.addEventListener("click",this.rotateLeft.bind(this)),c.addEventListener("click",this.rotateRight.bind(this))},rotateLeft:function(){this.rotate(-90)},rotateRight:function(){this.rotate(90)},rotate:function(b){this.darkroom.applyTransformation(new a({angle:b}))}})}(),function(){"use strict";var a=Darkroom.Transformation.extend({applyTransformation:function(a,b,c){var d=new Image;d.onload=function(){if(!(1>f||1>e)){var d=new fabric.Image(this,{selectable:!1,evented:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,lockUniScaling:!0,hasControls:!1,hasBorders:!1}),e=this.width,f=this.height;a.setWidth(e),a.setHeight(f),b.remove(),a.add(d),c(d)}};var e=Darkroom.Utils.computeImageViewPort(b),f=e.width,g=e.height,h=this.options.left*f,i=this.options.top*g,j=Math.min(this.options.width*f,f-h),k=Math.min(this.options.height*g,g-i);d.src=a.toDataURL({left:h,top:i,width:j,height:k})}}),b=fabric.util.createClass(fabric.Rect,{_render:function(a){this.callSuper("_render",a);var b=(a.canvas,7),c=this.flipX?-1:1,d=this.flipY?-1:1,e=c/this.scaleX,f=d/this.scaleY;a.scale(e,f),a.fillStyle="rgba(0, 0, 0, 0.5)",this._renderOverlay(a),void 0!==a.setLineDash?a.setLineDash([b,b]):void 0!==a.mozDash&&(a.mozDash=[b,b]),a.strokeStyle="rgba(0, 0, 0, 0.2)",this._renderBorders(a),this._renderGrid(a),a.lineDashOffset=b,a.strokeStyle="rgba(255, 255, 255, 0.4)",this._renderBorders(a),this._renderGrid(a),a.scale(1/e,1/f)},_renderOverlay:function(a){var b=a.canvas,c=0,d=Math.ceil(-this.getWidth()/2-this.getLeft()),e=Math.ceil(-this.getWidth()/2),f=Math.ceil(this.getWidth()/2),g=Math.ceil(this.getWidth()/2+(b.width-this.getWidth()-this.getLeft())),h=Math.ceil(-this.getHeight()/2-this.getTop()),i=Math.ceil(-this.getHeight()/2),j=Math.ceil(this.getHeight()/2),k=Math.ceil(this.getHeight()/2+(b.height-this.getHeight()-this.getTop()));a.fillRect(d,h,g-d,i-h+c),a.fillRect(d,i,e-d,j-i+c),a.fillRect(f,i,g-f,j-i+c),a.fillRect(d,j,g-d,k-j)},_renderBorders:function(a){a.beginPath(),a.moveTo(-this.getWidth()/2,-this.getHeight()/2),a.lineTo(this.getWidth()/2,-this.getHeight()/2),a.lineTo(this.getWidth()/2,this.getHeight()/2),a.lineTo(-this.getWidth()/2,this.getHeight()/2),a.lineTo(-this.getWidth()/2,-this.getHeight()/2),a.stroke()},_renderGrid:function(a){a.beginPath(),a.moveTo(-this.getWidth()/2+1/3*this.getWidth(),-this.getHeight()/2),a.lineTo(-this.getWidth()/2+1/3*this.getWidth(),this.getHeight()/2),a.stroke(),a.beginPath(),a.moveTo(-this.getWidth()/2+2/3*this.getWidth(),-this.getHeight()/2),a.lineTo(-this.getWidth()/2+2/3*this.getWidth(),this.getHeight()/2),a.stroke(),a.beginPath(),a.moveTo(-this.getWidth()/2,-this.getHeight()/2+1/3*this.getHeight()),a.lineTo(this.getWidth()/2,-this.getHeight()/2+1/3*this.getHeight()),a.stroke(),a.beginPath(),a.moveTo(-this.getWidth()/2,-this.getHeight()/2+2/3*this.getHeight()),a.lineTo(this.getWidth()/2,-this.getHeight()/2+2/3*this.getHeight()),a.stroke()}});Darkroom.plugins.crop=Darkroom.Plugin.extend({startX:null,startY:null,isKeyCroping:!1,isKeyLeft:!1,isKeyUp:!1,defaults:{minHeight:1,minWidth:1,ratio:null,quickCropKey:!1},initialize:function(){var a=this.darkroom.toolbar.createButtonGroup();this.cropButton=a.createButton({image:"crop"}),this.okButton=a.createButton({image:"done",type:"success",hide:!0}),this.cancelButton=a.createButton({image:"close",type:"danger",hide:!0}),this.cropButton.addEventListener("click",this.toggleCrop.bind(this)),this.okButton.addEventListener("click",this.cropCurrentZone.bind(this)),this.cancelButton.addEventListener("click",this.releaseFocus.bind(this)),this.darkroom.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.darkroom.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.darkroom.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.darkroom.canvas.on("object:moving",this.onObjectMoving.bind(this)),this.darkroom.canvas.on("object:scaling",this.onObjectScaling.bind(this)),fabric.util.addListener(fabric.document,"keydown",this.onKeyDown.bind(this)),fabric.util.addListener(fabric.document,"keyup",this.onKeyUp.bind(this)),this.darkroom.addEventListener("core:transformation",this.releaseFocus.bind(this))},onObjectMoving:function(a){if(this.hasFocus()){var b=a.target;if(b===this.cropZone){var c=this.darkroom.canvas,d=b.getLeft(),e=b.getTop(),f=b.getWidth(),g=b.getHeight(),h=c.getWidth()-f,i=c.getHeight()-g;0>d&&b.set("left",0),0>e&&b.set("top",0),d>h&&b.set("left",h),e>i&&b.set("top",i),this.darkroom.dispatchEvent("crop:update")}}},onObjectScaling:function(a){if(this.hasFocus()){var b=!1,c=a.target;if(c===this.cropZone){var d=this.darkroom.canvas,e=d.getPointer(a.e),f=(e.x,e.y,c.getLeft()),g=c.getTop(),h=c.getLeft()+c.getWidth(),i=c.getTop()+c.getHeight();if(null!==this.options.ratio&&(0>f||h>d.getWidth()||0>g||i>d.getHeight())&&(b=!0),0>f||h>d.getWidth()||b){var j=this.lastScaleX||1;c.setScaleX(j)}if(0>f&&c.setLeft(0),0>g||i>d.getHeight()||b){var k=this.lastScaleY||1;c.setScaleY(k)}0>g&&c.setTop(0),c.getWidth()<this.options.minWidth&&c.scaleToWidth(this.options.minWidth),c.getHeight()<this.options.minHeight&&c.scaleToHeight(this.options.minHeight),this.lastScaleX=c.getScaleX(),this.lastScaleY=c.getScaleY(),this.darkroom.dispatchEvent("crop:update")}}},onMouseDown:function(a){if(this.hasFocus()){var b=this.darkroom.canvas;b.calcOffset();var c=b.getPointer(a.e),d=c.x,e=c.y,f=new fabric.Point(d,e),g=b.getActiveObject();g===this.cropZone||this.cropZone.containsPoint(f)||(b.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.startX=d,this.startY=e)}},onMouseMove:function(a){if(this.isKeyCroping)return this.onMouseMoveKeyCrop(a);if(null!==this.startX&&null!==this.startY){var b=this.darkroom.canvas,c=b.getPointer(a.e),d=c.x,e=c.y;this._renderCropZone(this.startX,this.startY,d,e)}},onMouseMoveKeyCrop:function(a){var b=this.darkroom.canvas,c=this.cropZone,d=b.getPointer(a.e),e=d.x,f=d.y;c.left&&c.top||(c.setTop(f),c.setLeft(e)),this.isKeyLeft=e<c.left+c.width/2,this.isKeyUp=f<c.top+c.height/2,this._renderCropZone(Math.min(c.left,e),Math.min(c.top,f),Math.max(c.left+c.width,e),Math.max(c.top+c.height,f))},onMouseUp:function(a){if(null!==this.startX&&null!==this.startY){var b=this.darkroom.canvas;this.cropZone.setCoords(),b.setActiveObject(this.cropZone),b.calcOffset(),this.startX=null,this.startY=null}},onKeyDown:function(a){!1===this.options.quickCropKey||a.keyCode!==this.options.quickCropKey||this.isKeyCroping||(this.isKeyCroping=!0,this.darkroom.canvas.discardActiveObject(),this.cropZone.setWidth(0),this.cropZone.setHeight(0),this.cropZone.setScaleX(1),this.cropZone.setScaleY(1),this.cropZone.setTop(0),this.cropZone.setLeft(0))},onKeyUp:function(a){!1!==this.options.quickCropKey&&a.keyCode===this.options.quickCropKey&&this.isKeyCroping&&(this.isKeyCroping=!1,this.startX=1,this.startY=1,this.onMouseUp())},selectZone:function(a,b,c,d,e){this.hasFocus()||this.requireFocus(),e?this.cropZone.set({left:a,top:b,width:c,height:d}):this._renderCropZone(a,b,a+c,b+d);var f=this.darkroom.canvas;f.bringToFront(this.cropZone),this.cropZone.setCoords(),f.setActiveObject(this.cropZone),f.calcOffset(),this.darkroom.dispatchEvent("crop:update")},toggleCrop:function(){this.hasFocus()?this.releaseFocus():this.requireFocus()},cropCurrentZone:function(){if(this.hasFocus()&&!(this.cropZone.width<1&&this.cropZone.height<1)){var b=this.darkroom.image,c=this.cropZone.getTop()-b.getTop(),d=this.cropZone.getLeft()-b.getLeft(),e=this.cropZone.getWidth(),f=this.cropZone.getHeight();0>c&&(f+=c,c=0),0>d&&(e+=d,d=0),this.darkroom.applyTransformation(new a({top:c/b.getHeight(),left:d/b.getWidth(),width:e/b.getWidth(),height:f/b.getHeight()}))}},hasFocus:function(){return void 0!==this.cropZone},requireFocus:function(){this.cropZone=new b({fill:"transparent",hasBorders:!1,originX:"left",originY:"top",cornerColor:"#444",cornerSize:8,transparentCorners:!1,lockRotation:!0,hasRotatingPoint:!1}),null!==this.options.ratio&&this.cropZone.set("lockUniScaling",!0),this.darkroom.canvas.add(this.cropZone),this.darkroom.canvas.defaultCursor="crosshair",this.cropButton.active(!0),this.okButton.hide(!1),this.cancelButton.hide(!1)},releaseFocus:function(){void 0!==this.cropZone&&(this.cropZone.remove(),this.cropZone=void 0,this.cropButton.active(!1),this.okButton.hide(!0),this.cancelButton.hide(!0),this.darkroom.canvas.defaultCursor="default",this.darkroom.dispatchEvent("crop:update"))},_renderCropZone:function(a,b,c,d){var e=this.darkroom.canvas,f=c>a,g=!f,h=d>b,i=!h,j=Math.min(+this.options.minWidth,e.getWidth()),k=Math.min(+this.options.minHeight,e.getHeight()),l=Math.min(a,c),m=Math.max(a,c),n=Math.min(b,d),o=Math.max(b,d);l=Math.max(0,l),m=Math.min(e.getWidth(),m),n=Math.max(0,n),o=Math.min(e.getHeight(),o),j>m-l&&(f?m=l+j:l=m-j),k>o-n&&(h?o=n+k:n=o-k),0>l&&(m+=Math.abs(l),l=0),m>e.getWidth()&&(l-=m-e.getWidth(),m=e.getWidth()),0>n&&(o+=Math.abs(n),n=0),o>e.getHeight()&&(n-=o-e.getHeight(),o=e.getHeight());var p=m-l,q=o-n,r=p/q;if(this.options.ratio&&+this.options.ratio!==r){var s=+this.options.ratio;if(this.isKeyCroping&&(g=this.isKeyLeft,i=this.isKeyUp),s>r){var t=q*s;g&&(l-=t-p),p=t}else if(r>s){var u=q/(s*q/p);i&&(n-=u-q),q=u}if(0>l&&(l=0),0>n&&(n=0),l+p>e.getWidth()){var t=e.getWidth()-l;q=t*q/p,p=t,i&&(n=b-q)}if(n+q>e.getHeight()){var u=e.getHeight()-n;p=p*u/q,q=u,g&&(l=a-p)}}this.cropZone.left=l,this.cropZone.top=n,this.cropZone.width=p,this.cropZone.height=q,this.darkroom.canvas.bringToFront(this.cropZone),this.darkroom.dispatchEvent("crop:update")}})}(),function(a,b,c,d){"use strict";d.plugins.save=d.Plugin.extend({defaults:{callback:function(){this.darkroom.selfDestroy(),c.publish("image-edit:save",{oImage:this.darkroom.image._element})}},initialize:function(){var a=this.darkroom.toolbar.createButtonGroup();this.destroyButton=a.createButton({image:"save"}),this.destroyButton.addEventListener("click",this.options.callback.bind(this))}})}(window,document,FrontendMediator,Darkroom),function(a,b,c,d,e,f){"use strict";e.define("image-edit",[],function(){return{sPathCss:c.sPathCssUI+"?v="+c.sHash,oDefault:{zoom:3,zoomable:!0,plugins:{crop:{minHeight:50,minWidth:50,ratio:1}}},onStart:function(){var a=d.getDataModules("image-edit"),b=this;d.loadCSS(this.sPathCss),d.trackModule("JS_Libraries","call","image-edit"),f(a).each(function(a){b.autobind(this,a)})},autobind:function(a,b){""===a.id&&(a.id="edit-image-"+b),f(a).addClass("magnifier-thumb-wrapper");var c,e,g=this,h="350px",i="350px";null!==a.getAttribute("data-fc-width")&&(h=a.getAttribute("data-fc-width").replace("px","")+"px"),null!==a.getAttribute("data-fc-height")&&(i=a.getAttribute("data-fc-height").replace("px","")+"px"),e={minWidth:h,minHeight:i},c=d.mergeOptions(g.oDefault,e),new Darkroom("#"+a.id,c),f(a).on("click",function(){f(".darkroom-toolbar").slideToggle()})},onStop:function(){this.sPathCss=null},onDestroy:function(){delete this.sPathCss}}})}(window,document,oGlobalSettings,FrontendTools,FrontendCore,$);